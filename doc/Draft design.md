# Эскизный проект лабораторного стенда ТАР

---

## 1. Введение  

### 1.1. Назначение стенда  
Лабораторный стенд предназначен для:  
- Обучения студентов основам автоматического регулирования и ПИД-регулирования на примере тепловой системы.  
- Изучения принципов построения IoT-систем с использованием микроконтроллеров ESP32 и одноплатного компьютера Raspberry Pi.  
- Исследования влияния внешних помех на стабильность и качество регулирования температуры.  
- Разработки и отладки алгоритмов управления в реальном времени с возможностью удаленного доступа.  

### 1.2. Основные требования  
- Поддержание температуры воды в системе с точностью не хуже ±1°C.  
- Возможность управления тремя ключевыми исполнительными элементами: нагревателем, помпой и охлаждающим элементом (вентиляторами).  
- Реализация двухуровневого управления: студенты управляют помпой и охлаждением, преподаватель - нагревателем и вводит помехи.  
- Обеспечение удаленного доступа студентов и преподавателя с разграничением прав доступа.  
- Визуализация текущих параметров системы и истории изменений в реальном времени через веб-интерфейс.  
- Логирование данных для последующего анализа и отчётности.  

---

## 2. Общие технические решения  

### 2.1. Архитектура системы  

Система состоит из двух основных контроллеров:  
- **Контроллер студента (ESP32)** - отвечает за сбор данных с датчиков, управление помпой и охлаждением, передачу данных преподавателю и студентам.  
- **Контроллер преподавателя (Raspberry Pi 4)** - управляет нагревателем, моделирует помехи, предоставляет веб-интерфейс для преподавателя, собирает и хранит данные.  

Связь между контроллерами и пользователями осуществляется по Wi-Fi через MQTT-протокол. Студенты подключаются напрямую к ESP32, преподаватель - к Raspberry Pi через веб-браузер.  

flowchart TD
A[Датчики температуры, расхода, тахометр] --> B(ESP32 - контроллер студента)
B --> C[Исполнительные устройства: помпа, вентиляторы]
B --> D[Raspberry Pi - контроллер преподавателя]
D --> E[Исполнительное устройство: нагреватель]
D --> F[Веб-интерфейс преподавателя]
B --> G[Wi-Fi сеть]
D --> G
Студенты -->|Wi-Fi| B
Преподаватель -->|Веб-интерфейс| D

text

### 2.2. Основные компоненты  

| Категория               | Компоненты                                                                                      | Кол-во | Описание и характеристики                                            |
|------------------------|------------------------------------------------------------------------------------------------|--------|---------------------------------------------------------------------|
| Микроконтроллеры        | ESP32 DevKit C, Raspberry Pi 4 (4 ГБ RAM)                                                      | 1 + 1  | ESP32 - управление датчиками и исполнительными устройствами, Raspberry Pi - преподавательский контроллер и сервер |
| Температурные датчики   | DS18B20 (водонепроницаемые)                                                                    | 2      | Измерение температуры на входе и выходе нагревателя                  |
| Датчики расхода жидкости| YF-S201                                                                                        | 2      | Измерение объёма жидкости после помпы и после охлаждающего элемента  |
| Тахометр вентиляторов   | HW-080 или аналогичный инфракрасный/холл-датчик                                               | 1      | Измерение скорости вращения вентиляторов                             |
| Исполнительные устройства| Нагреватель (керамический ТЭН 12В/50Вт), помпа 12В/6 л/мин, кулеры 120×120 мм (12В)            | 1,1,2  | Управление мощностью нагрева, циркуляцией и охлаждением              |
| Управляющие элементы    | MOSFET IRFZ44N, драйвер L298N, транзистор 2N2222, реле с опторазвязкой                         | Комплект| Обеспечение безопасного и эффективного управления исполнительными устройствами |
| Блок питания            | Стабилизированный 12В/5А с защитой от КЗ и перегрузки                                         | 1      | Питание всех компонентов                                             |
| Коммуникации            | Wi-Fi (ESP32 и Raspberry Pi), MQTT-брокер Mosquitto                                           | -      | Обеспечение обмена данными и управления                              |

---

## 3. Детализация аппаратной части  

### 3.1. Схема подключения  

- **Датчики температуры DS18B20** подключены к ESP32 по 1-Wire интерфейсу с использованием одного GPIO.  
- **Датчики расхода YF-S201** подключены к цифровым входам ESP32 с прерыванием для подсчёта импульсов.  
- **Тахометр вентиляторов** подключён к цифровому входу ESP32.  
- **Исполнительные устройства** управляются ESP32 через MOSFET и драйверы с использованием ШИМ-сигналов.  
- **Нагреватель** управляется Raspberry Pi через реле с опторазвязкой.  
- Связь между ESP32 и Raspberry Pi реализована по Wi-Fi через MQTT-протокол.  

(Полная электрическая схема прилагается в приложении)

### 3.2. Расчёты  

#### 3.2.1. Тепловая мощность и время нагрева  
- Масса воды: 1.5 кг  
- Удельная теплоёмкость воды: 4200 Дж/(кг·°C)  
- Необходимое изменение температуры: ΔT = 10°C  
- Энергия для нагрева: Q = m × c × ΔT = 1.5 × 4200 × 10 = 63 000 Дж  
- Мощность нагревателя: 50 Вт  
- Время нагрева: t = Q / P = 63 000 / 50 = 1260 секунд ≈ 21 минута  

#### 3.2.2. Электрические параметры и защита  
| Компонент   | Напряжение | Ток  | Защита                      |
|-------------|------------|------|-----------------------------|
| Нагреватель | 12 В       | 4.2 А| Реле с опторазвязкой        |
| Помпа       | 12 В       | 0.5 А| Диод 1N4007 для защиты от обратного напряжения |
| Кулеры      | 12 В       | 0.3 А| Транзистор 2N2222           |

---

## 4. Программное обеспечение  

### 4.1. Алгоритм ПИД-регулирования  
- Используется классический ПИД-регулятор с настройкой коэффициентов Kp, Ki, Kd.  
- Обновление управляющего сигнала происходит с периодом 1 секунда.  
- Выходной сигнал ограничен диапазоном 0–255 для управления ШИМ.  

Пример инициализации ПИД:  
double Kp = 2.0, Ki = 0.1, Kd = 0.5;
PID myPID(&Input, &Output, &Setpoint, Kp, Ki, Kd, DIRECT);

void setup() {
myPID.SetSampleTime(1000);
myPID.SetOutputLimits(0, 255);
myPID.SetMode(AUTOMATIC);
}

text

### 4.2. Генерация помех преподавателем  
- Преподаватель может включать/выключать помехи через веб-интерфейс.  
- Помехи реализуются как произвольное включение/выключение помпы и вентиляторов с заданной периодичностью.  

Пример функции генерации помех:  
void generateNoise() {
if (millis() - lastNoiseTime > random(5000, 15000)) {
digitalWrite(PUMP_PIN, random(0, 2));
digitalWrite(COOLER_PIN, random(0, 2));
lastNoiseTime = millis();
}
}

text

### 4.3. Веб-интерфейс преподавателя  
- Реализован на Raspberry Pi с использованием Node-RED и MQTT.  
- Отображает графики температуры, расхода и скорости вентиляторов в реальном времени.  
- Позволяет задавать параметры помех и просматривать логи.  

---

### 4.4. Архитектура программного обеспечения

Для реализации серверной и клиентской части лабораторного стенда предлагается использовать современный стек:

- **Backend:** Node.js с использованием Express.js для построения REST API.
- **База данных:** PostgreSQL с ORM Sequelize для удобного взаимодействия с базой.
- **Frontend:** React.js для создания динамичного и отзывчивого веб-интерфейса.

Данные с микроконтроллеров (ESP32) через MQTT или REST API поступают на backend, где сохраняются в PostgreSQL. Frontend взаимодействует с backend через REST API для отображения данных и управления системой.

---

### 4.5. Node.js Backend

- Используется **Express.js** для создания REST API с методами CRUD (Create, Read, Update, Delete) для управления параметрами стенда и сохранения данных.  
- Для работы с PostgreSQL применяется **Sequelize ORM**, обеспечивающий удобное описание моделей и запросов.  
- Основные API эндпоинты:  
  - `GET /api/sensors` – получить данные с датчиков  
  - `POST /api/config` – обновить конфигурацию управления  
  - `PUT /api/config/:id` – изменить параметры конкретного элемента  
  - `DELETE /api/logs` – очистить логи  
- Используется **JWT** или OAuth2 для аутентификации и разграничения прав доступа.

---

### 4.6. React.js Frontend

- Интерфейс разделён на компоненты, обеспечивающие модульность и переиспользуемость:  
  - **Dashboard** – отображение графиков температуры, расхода и скорости вентиляторов (с использованием библиотек Chart.js или Recharts).  
  - **ControlPanel** – управление параметрами нагревателя, помпы и вентилятора.  
  - **UserManagement** – интерфейс для аутентификации и управления пользователями.  
- Для взаимодействия с backend используется **Axios** для выполнения HTTP-запросов (GET, POST, PUT, DELETE).  
- Навигация реализована с помощью **React Router**.  
- Для стилизации можно использовать **Bootstrap** или **Material-UI**.

---

### 4.7. Интеграция и тестирование

- Создаётся тестовый набор интеграционных тестов, проверяющих корректность CRUD операций между React frontend и Node.js backend с PostgreSQL.  
- Используются инструменты тестирования, например, Jest и Supertest для backend, React Testing Library для frontend.

---

### 4.8. Общая архитектура системы

flowchart TD
ESP32[ESP32 - Контроллер студента] --> MQTT[MQTT брокер]
MQTT --> NodeJS[Node.js Backend (Express + Sequelize)]
NodeJS --> PostgreSQL[PostgreSQL DB]
NodeJS --> React[React.js Frontend]
User[Студенты / Преподаватель] --> React

text

- Данные с ESP32 поступают через MQTT брокер на Node.js backend, где сохраняются в PostgreSQL.  
- React frontend запрашивает данные у backend и отображает их пользователям.  
- Пользовательские команды с фронтенда передаются на backend, который отправляет управляющие сигналы на ESP32.

---

### 4.9. Преимущества выбранного стека

- **Масштабируемость и производительность:** Node.js хорошо справляется с большим количеством одновременных запросов.  
- **Удобство разработки:** React.js обеспечивает динамичный и отзывчивый UI.  
- **Надёжное хранение данных:** PostgreSQL - мощная реляционная база с поддержкой транзакций и сложных запросов.  
- **Гибкость:** Sequelize ORM упрощает работу с базой и миграциями.  
- **Безопасность:** JWT/OAuth2 обеспечивают контроль доступа.

---

## 5. Сетевая инфраструктура  

### 5.1. Топология сети  
- ESP32 и Raspberry Pi подключены к локальной Wi-Fi сети.  
- MQTT-брокер Mosquitto развернут на Raspberry Pi.  
- Студенты подключаются к ESP32 по Wi-Fi для мониторинга и управления.  
- Преподаватель подключается к Raspberry Pi через веб-браузер.  

### 5.2. Протоколы и безопасность  
| Параметр      | Значение                         |
|---------------|---------------------------------|
| Протокол      | MQTT over TLS 1.2               |
| Аутентификация| OAuth2 для веб-интерфейса       |
| Шифрование    | TLS с сертификатами Let's Encrypt|

---

## 6. Безопасность  

### 6.1. Аппаратная защита  
- Использование оптоизоляторов PC817 для гальванической развязки цепей управления.  
- Аварийное отключение нагревателя при превышении температуры 90°C с помощью датчика DS18B20 и реле.  
- Защита от короткого замыкания и перегрузок в блоке питания.  

### 6.2. Программная защита  
- Watchdog Timer на ESP32 для автоматического перезапуска при зависании.  
- Контроль корректности данных с датчиков с фильтрацией выбросов.  
- Разграничение прав доступа студентов и преподавателей.  

---

## 7. Бюджетная часть  

| Компонент                | Кол-во | Цена за шт (руб.) | Общая стоимость (руб.) | Примечания                            |
|-------------------------|--------|-------------------|-----------------------|-------------------------------------|
| ESP32 DevKit C          | 1      | 1 600             | 1 600                 |                                     |
| Raspberry Pi 4 (4 ГБ)   | 1      | 6 000             | 6 000                 |                                     |
| DS18B20 (водонепроницаемые) | 2      | 300               | 600                   |                                     |
| YF-S201                 | 2      | 700               | 1 400                 |                                     |
| Нагреватель 12В/50Вт    | 1      | 1 000             | 1 000                 | С керамическим изолятором           |
| Помпа 12В               | 1      | 1 200             | 1 200                 |                                     |
| Вентиляторы 120×120 мм  | 2      | 400               | 800                   |                                     |
| Блок питания 12В/5А     | 1      | 1 200             | 1 200                 | Защита от КЗ и перегрузки           |
| Прочие компоненты       | -      | -                 | 1 000                 | Клеммники, провода, корпуса и др.   |
| **Итого**               | -      | -                 | **14 800**            |                                     |

---

## 8. Этапы реализации  

| Этап                     | Описание                                   | Сроки (дни) |
|--------------------------|--------------------------------------------|-------------|
| Закупка компонентов       | Заказ и получение всех комплектующих       | 3           |
| Сборка и монтаж          | Монтаж, пайка, подключение всех элементов  | 5           |
| Настройка программного обеспечения | Разработка и загрузка прошивок, настройка Node-RED | 2           |
| Тестирование и отладка   | Проверка работы, калибровка, исправление ошибок | 3           |

---

## 9. Приложения  

- Полная электрическая схема стенда с номиналами и указанием защитных элементов.  
- Пример исходного кода для ESP32 с ПИД-регулятором и MQTT-клиентом.  
- Инструкция по установке и настройке Node-RED и MQTT-брокера на Raspberry Pi.  
- Руководство пользователя для студентов и преподавателей.  

---

## 10. Заключение  

Данный эскизный проект подтверждает техническую реализуемость лабораторного стенда для автоматического регулирования температуры воды с использованием современных IoT-технологий. Система обеспечивает гибкое и безопасное управление, удобный интерфейс для преподавателя и студентов, а также возможность моделирования внешних помех.  

Для перехода к этапу технического проектирования необходимо:  
- Утвердить расчёты тепловой мощности и электрических параметров.  
- Провести испытания на электромагнитную совместимость (EMC).  
- Согласовать бюджет и сроки с заказчиком.  

---
